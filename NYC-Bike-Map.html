<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>NYC Bike Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; z-index: 1; }
        #map.draw-mode { cursor: crosshair; }
        
        .panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: calc(100vw - 20px);
            overflow: hidden;
        }
        .panel-header {
            background: linear-gradient(135deg, #1a73e8, #0d47a1);
            color: white;
            padding: 12px 16px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .panel-header span { font-size: 1.1rem; }
        .panel-toggle { font-size: 1.2rem; transition: transform 0.3s; }
        .panel.collapsed .panel-toggle { transform: rotate(180deg); }
        .panel-content { padding: 12px 16px; max-height: 50vh; overflow-y: auto; }
        .panel.collapsed .panel-content { display: none; }
        
        .layer-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }
        .layer-item:last-child { border-bottom: none; }
        .layer-item input { width: 18px; height: 18px; margin-right: 10px; cursor: pointer; }
        .color-dot { width: 14px; height: 14px; border-radius: 3px; margin-right: 10px; flex-shrink: 0; }
        .dot-protected { background: #00a651; }
        .dot-standard { background: #0066cc; }
        .dot-sharrows { background: #ff9800; }
        .dot-citibike { background: #e91e63; border-radius: 50%; }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 24px 32px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
            z-index: 2000;
            text-align: center;
            max-width: 90vw;
        }
        .loading.hidden { display: none; }
        .spinner {
            width: 36px;
            height: 36px;
            border: 4px solid #e0e0e0;
            border-top-color: #1a73e8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .status { font-size: 0.85rem; color: #666; margin-top: 8px; }
        .error { color: #d32f2f; }
        
        /* Path creator */
        .section-divider { border-top: 1px solid #e5e7eb; margin: 10px 0 6px; }
        .section-label { font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .mode-btn {
            display: inline-block; padding: 6px 10px; margin: 2px;
            border: 2px solid #ddd; border-radius: 6px; background: white;
            cursor: pointer; font-size: 12px; font-weight: 500;
        }
        .mode-btn.active { border-color: #2563eb; background: #eff6ff; color: #2563eb; }
        .path-action {
            display: block; width: 100%; padding: 6px; margin-top: 4px;
            border: 1px solid #ddd; border-radius: 6px; background: white;
            cursor: pointer; font-size: 12px; text-align: center;
        }
        .path-action:hover { background: #f8f8f8; }
        .path-action.save { background: #2563eb; color: white; border-color: #2563eb; }
        .path-action.save:hover { background: #1d4ed8; }
        .path-action.danger { color: #dc2626; border-color: #fca5a5; }
        .path-action.danger:hover { background: #fef2f2; }
        .saved-list { margin-top: 6px; max-height: 150px; overflow-y: auto; }
        .saved-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 5px 8px; border: 1px solid #e5e7eb; border-radius: 6px;
            margin-top: 3px; font-size: 12px; cursor: pointer;
        }
        .saved-item:hover { background: #f0f7ff; }
        .saved-item .name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .saved-item .del {
            width: 20px; height: 20px; border: none; background: none;
            color: #9ca3af; cursor: pointer; font-size: 14px; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
        }
        .saved-item .del:hover { color: #dc2626; background: #fee2e2; }
        #distance-badge {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: rgba(0,0,0,0.75); color: white;
            padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 500;
            display: none; pointer-events: none;
        }
        #save-dialog {
            display: none; position: fixed; inset: 0; z-index: 2000;
            background: rgba(0,0,0,0.4); align-items: center; justify-content: center;
        }
        #save-dialog.show { display: flex; }
        #save-dialog .dialog {
            background: white; border-radius: 12px; padding: 20px;
            width: 280px; box-shadow: 0 4px 24px rgba(0,0,0,0.2);
        }
        #save-dialog input {
            width: 100%; padding: 8px 10px; border: 1px solid #d1d5db;
            border-radius: 6px; font-size: 14px; margin: 10px 0;
        }
        #save-dialog .btns { display: flex; gap: 8px; }
        #save-dialog .btns button {
            flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #ddd;
            font-size: 14px; cursor: pointer;
        }
        #save-dialog .btns .confirm { background: #2563eb; color: white; border-color: #2563eb; }

        .leaflet-popup-content { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .leaflet-popup-content h4 { margin: 0 0 6px 0; font-size: 1rem; }
        .leaflet-popup-content p { margin: 3px 0; font-size: 0.85rem; color: #555; }
        
        .locate-btn {
            position: absolute;
            bottom: 100px;
            right: 10px;
            z-index: 1000;
            background: white;
            border: 2px solid rgba(0,0,0,0.2);
            border-radius: 4px;
            width: 34px;
            height: 34px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .locate-btn:hover { background: #f4f4f4; }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="panel" id="panel">
        <div class="panel-header" onclick="document.getElementById('panel').classList.toggle('collapsed')">
            <span>üö≤ NYC Bike Map</span>
            <span class="panel-toggle">‚ñº</span>
        </div>
        <div class="panel-content">
            <label class="layer-item">
                <input type="checkbox" id="tog-protected" checked>
                <span class="color-dot dot-protected"></span>
                Class I - Protected/Path
            </label>
            <label class="layer-item">
                <input type="checkbox" id="tog-standard" checked>
                <span class="color-dot dot-standard"></span>
                Class II - Bike Lane
            </label>
            <label class="layer-item">
                <input type="checkbox" id="tog-sharrows" checked>
                <span class="color-dot dot-sharrows"></span>
                Class III - Shared/Signed
            </label>
            <label class="layer-item">
                <input type="checkbox" id="tog-citibike" checked>
                <span class="color-dot dot-citibike"></span>
                Citi Bike Stations
            </label>
            
            <div class="section-divider"></div>
            <div class="section-label">üìç Path Creator</div>
            <div>
                <button class="mode-btn active" id="btn-draw" onclick="setDrawMode('draw')">‚úèÔ∏è Draw</button>
                <button class="mode-btn" id="btn-move" onclick="setDrawMode('move')">üó∫Ô∏è Move</button>
            </div>
            <button class="path-action" onclick="undoLastPoint()">‚Ü© Undo</button>
            <button class="path-action save" onclick="showSaveDialog()">üíæ Save Path</button>
            <button class="path-action danger" onclick="clearDrawnPath()">üóë Clear</button>
            <div class="section-label" style="margin-top:8px;">Saved Paths</div>
            <div class="saved-list" id="saved-list"></div>
        </div>
    </div>
    
    <button class="locate-btn" id="locateBtn" title="Find my location">üìç</button>
    
    <div id="distance-badge"></div>
    
    <div id="save-dialog">
        <div class="dialog">
            <div style="font-weight:600;font-size:16px;">Save Path</div>
            <input type="text" id="path-name" placeholder="e.g. Morning commute">
            <div class="btns">
                <button onclick="closeSaveDialog()">Cancel</button>
                <button class="confirm" onclick="saveDrawnPath()">Save</button>
            </div>
        </div>
    </div>
    
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>Loading...</div>
        <div class="status" id="status">Waiting for libraries...</div>
    </div>

    <script>
    // Load Leaflet dynamically
    var script = document.createElement('script');
    script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    script.onload = initMap;
    script.onerror = function() {
        document.getElementById('loading').innerHTML = '<div class="error">Failed to load Leaflet</div>';
    };
    document.head.appendChild(script);
    
    function initMap() {
        var loading = document.getElementById('loading');
        var status = document.getElementById('status');
        
        function setStatus(msg) {
            status.textContent = msg;
        }
        
        setStatus('Creating map...');
        
        var map = L.map('map').setView([40.7484, -73.9857], 13);
        
        // Custom pane for bike data so we can disable clicks during drawing
        map.createPane('bikeData');
        map.getPane('bikeData').style.zIndex = 400;
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© OpenStreetMap'
        }).addTo(map);
        
        setStatus('Loading bike routes...');
        
        var protectedLayer = L.layerGroup().addTo(map);
        var standardLayer = L.layerGroup().addTo(map);
        var sharrowsLayer = L.layerGroup().addTo(map);
        var citibikeLayer = L.layerGroup().addTo(map);
        
        // Colors based on bike lane classification
        var COLORS = {
            protected: '#00a651',  // Class I - green
            standard: '#0066cc',   // Class II - blue  
            sharrows: '#ff9800'    // Class III - orange
        };
        
        var BIKE_ROUTES_URL = 'https://data.cityofnewyork.us/resource/mzxg-pwib.geojson?$limit=50000';
        
        fetch(BIKE_ROUTES_URL)
            .then(function(res) { 
                if (!res.ok) throw new Error('HTTP ' + res.status);
                return res.json(); 
            })
            .then(function(data) {
                setStatus('Drawing ' + data.features.length + ' routes...');
                
                var counts = { protected: 0, standard: 0, sharrows: 0 };
                
                data.features.forEach(function(feature) {
                    if (!feature.geometry) return;
                    
                    var props = feature.properties || {};
                    var streetName = props.street || props.fromstreet || 'Bike Route';
                    var facilityClass = props.facilitycl || '';  // "I", "II", "III", "L"
                    var facilityType = props.ft_facilit || props.tf_facilit || '';  // "Protected", "Shared", etc.
                    var isGreenway = props.grnwy === 'Greenway';
                    
                    // Classify based on facilitycl (the standard bike lane classification)
                    var type, color, targetLayer;
                    
                    if (facilityClass === 'I' || isGreenway) {
                        // Class I: Protected bike lanes, paths, greenways
                        type = 'protected';
                        color = COLORS.protected;
                        targetLayer = protectedLayer;
                        counts.protected++;
                    } else if (facilityClass === 'III') {
                        // Class III: Shared lanes, sharrows, signed routes
                        type = 'sharrows';
                        color = COLORS.sharrows;
                        targetLayer = sharrowsLayer;
                        counts.sharrows++;
                    } else {
                        // Class II (and L for links): Standard bike lanes
                        type = 'standard';
                        color = COLORS.standard;
                        targetLayer = standardLayer;
                        counts.standard++;
                    }
                    
                    try {
                        var line = L.geoJSON(feature, {
                            style: { color: color, weight: 3, opacity: 0.8 },
                            pane: 'bikeData'
                        });
                        
                        var popupContent = '<h4>üõ§Ô∏è ' + streetName + '</h4>' +
                            '<p><b>Class:</b> ' + (facilityClass || '?') + '</p>' +
                            '<p><b>Type:</b> ' + (facilityType || 'N/A') + '</p>';
                        if (isGreenway && props.gwsystem) {
                            popupContent += '<p><b>Greenway:</b> ' + props.gwsystem + '</p>';
                        }
                        
                        line.bindPopup(popupContent);
                        line.addTo(targetLayer);
                    } catch(e) {}
                });
                
                console.log('Route counts:', counts);
                setStatus('Loading Citi Bike stations...');
                
                return loadCitiBike();
            })
            .then(function() {
                loading.classList.add('hidden');
            })
            .catch(function(err) {
                console.error(err);
                loading.innerHTML = '<div class="error">Error</div><div class="status">' + err.message + '</div>';
            });
        
        function loadCitiBike() {
            return Promise.all([
                fetch('https://gbfs.citibikenyc.com/gbfs/2.3/en/station_information.json').then(function(r) { return r.json(); }),
                fetch('https://gbfs.citibikenyc.com/gbfs/2.3/en/station_status.json').then(function(r) { return r.json(); })
            ]).then(function(results) {
                var stations = results[0].data.stations;
                var statuses = {};
                results[1].data.stations.forEach(function(s) { statuses[s.station_id] = s; });
                
                stations.forEach(function(station) {
                    var s = statuses[station.station_id] || {};
                    var marker = L.circleMarker([station.lat, station.lon], {
                        radius: 6, fillColor: '#e91e63', color: '#fff', weight: 2, opacity: 1, fillOpacity: 0.9,
                        pane: 'bikeData'
                    });
                    marker.bindPopup(
                        '<h4>üö≤ ' + station.name + '</h4>' +
                        '<p><b>Bikes:</b> ' + (s.num_bikes_available !== undefined ? s.num_bikes_available : '?') +
                        ' &nbsp; <b>Docks:</b> ' + (s.num_docks_available !== undefined ? s.num_docks_available : '?') + '</p>' +
                        '<p><b>E-bikes:</b> ' + (s.num_ebikes_available || 0) + ' &nbsp; <b>Capacity:</b> ' + station.capacity + '</p>'
                    );
                    marker.addTo(citibikeLayer);
                });
            });
        }
        
        // Layer toggles
        document.getElementById('tog-protected').addEventListener('change', function(e) {
            if (e.target.checked) map.addLayer(protectedLayer); else map.removeLayer(protectedLayer);
        });
        document.getElementById('tog-standard').addEventListener('change', function(e) {
            if (e.target.checked) map.addLayer(standardLayer); else map.removeLayer(standardLayer);
        });
        document.getElementById('tog-sharrows').addEventListener('change', function(e) {
            if (e.target.checked) map.addLayer(sharrowsLayer); else map.removeLayer(sharrowsLayer);
        });
        document.getElementById('tog-citibike').addEventListener('change', function(e) {
            if (e.target.checked) map.addLayer(citibikeLayer); else map.removeLayer(citibikeLayer);
        });
        
        // Geolocation
        document.getElementById('locateBtn').addEventListener('click', function() {
            map.locate({ setView: true, maxZoom: 16 });
        });
        
        var locationMarker;
        map.on('locationfound', function(e) {
            if (locationMarker) map.removeLayer(locationMarker);
            locationMarker = L.circleMarker(e.latlng, {
                radius: 10, fillColor: '#4285f4', color: '#fff', weight: 3, fillOpacity: 1
            }).addTo(map);
            locationMarker.bindPopup('You are here').openPopup();
        });
        
        map.on('locationerror', function(e) {
            alert('Location error: ' + e.message);
        });
        
        // ‚îÄ‚îÄ Path Creator ‚îÄ‚îÄ
        var drawMode = 'draw';
        var drawPoints = [];
        var drawMarkers = [];
        var drawPolyline = L.polyline([], { color: '#e53935', weight: 4, opacity: 0.9, dashArray: '8,6' }).addTo(map);
        var PATH_STORAGE = 'nyc_bike_paths';
        var loadedPathLayers = []; // track loaded saved path layers
        
        // Intercept clicks at DOM level BEFORE Leaflet processes them
        // Capture phase (true) means this fires before Leaflet's handlers
        var mapContainer = map.getContainer();
        var drawClickPending = false;
        
        mapContainer.addEventListener('click', function(e) {
            if (drawMode !== 'draw') return; // let Leaflet handle normally
            
            // Don't intercept clicks on the controls panel or buttons
            if (e.target.closest('.panel') || e.target.closest('.locate-btn') || 
                e.target.closest('#save-dialog') || e.target.closest('#distance-badge')) return;
            
            // Stop Leaflet from processing this click (no popups)
            e.stopPropagation();
            
            // Convert pixel position to map coordinates
            var rect = mapContainer.getBoundingClientRect();
            var point = L.point(e.clientX - rect.left, e.clientY - rect.top);
            var latlng = map.containerPointToLatLng(point);
            addDrawPoint(latlng);
        }, true); // <-- capture phase
        
        function addDrawPoint(latlng) {
            drawPoints.push(latlng);
            drawPolyline.setLatLngs(drawPoints);
            
            var marker = L.circleMarker(latlng, {
                radius: 6, fillColor: '#e53935', color: 'white', weight: 2, fillOpacity: 1
            }).addTo(map);
            
            // Drag to adjust
            marker.on('mousedown', function() {
                if (drawMode !== 'draw') return;
                var idx = drawMarkers.indexOf(marker);
                function onMove(ev) {
                    drawPoints[idx] = ev.latlng;
                    marker.setLatLng(ev.latlng);
                    drawPolyline.setLatLngs(drawPoints);
                    updatePathDistance();
                }
                map.dragging.disable();
                map.on('mousemove', onMove);
                map.once('mouseup', function() {
                    map.off('mousemove', onMove);
                    map.dragging.enable();
                });
            });
            
            drawMarkers.push(marker);
            updatePathDistance();
        }
        
        window.undoLastPoint = function() {
            if (drawPoints.length === 0) return;
            drawPoints.pop();
            var m = drawMarkers.pop();
            map.removeLayer(m);
            drawPolyline.setLatLngs(drawPoints);
            updatePathDistance();
        };
        
        window.clearDrawnPath = function() {
            drawPoints = [];
            drawPolyline.setLatLngs([]);
            drawMarkers.forEach(function(m) { map.removeLayer(m); });
            drawMarkers = [];
            updatePathDistance();
        };
        
        function updatePathDistance() {
            var badge = document.getElementById('distance-badge');
            if (drawPoints.length < 2) { badge.style.display = 'none'; return; }
            var total = 0;
            for (var i = 1; i < drawPoints.length; i++) {
                total += drawPoints[i - 1].distanceTo(drawPoints[i]);
            }
            badge.textContent = (total / 1609.34).toFixed(2) + ' mi (' + (total / 1000).toFixed(2) + ' km)';
            badge.style.display = 'block';
        }
        
        window.setDrawMode = function(m) {
            drawMode = m;
            document.getElementById('btn-draw').className = 'mode-btn' + (m === 'draw' ? ' active' : '');
            document.getElementById('btn-move').className = 'mode-btn' + (m === 'move' ? ' active' : '');
            document.getElementById('map').className = (m === 'draw') ? 'draw-mode' : '';
        };
        // Set initial cursor
        document.getElementById('map').className = 'draw-mode';
        
        // Save / Load
        function getSavedPaths() {
            try { return JSON.parse(localStorage.getItem(PATH_STORAGE) || '[]'); }
            catch(e) { return []; }
        }
        
        window.showSaveDialog = function() {
            if (drawPoints.length < 2) { alert('Add at least 2 points first.'); return; }
            document.getElementById('save-dialog').className = 'show';
            var input = document.getElementById('path-name');
            input.value = '';
            setTimeout(function() { input.focus(); }, 100);
        };
        
        window.closeSaveDialog = function() {
            document.getElementById('save-dialog').className = '';
        };
        
        window.saveDrawnPath = function() {
            var name = document.getElementById('path-name').value.trim();
            if (!name) { alert('Enter a name.'); return; }
            var saved = getSavedPaths();
            saved.push({
                name: name,
                pts: drawPoints.map(function(p) { return [Math.round(p.lat * 1e6) / 1e6, Math.round(p.lng * 1e6) / 1e6]; }),
                date: new Date().toISOString().slice(0, 10)
            });
            localStorage.setItem(PATH_STORAGE, JSON.stringify(saved));
            closeSaveDialog();
            renderSavedPaths();
            // Clear current drawing after save
            clearDrawnPath();
        };
        
        window.loadSavedPath = function(idx) {
            // Remove previously loaded saved path layers
            loadedPathLayers.forEach(function(layer) { map.removeLayer(layer); });
            loadedPathLayers = [];
            
            var saved = getSavedPaths();
            var path = saved[idx];
            if (!path) return;
            
            var latlngs = path.pts.map(function(p) { return L.latLng(p[0], p[1]); });
            
            // Show as a distinct layer (purple, solid) so it doesn't conflict with drawing
            var line = L.polyline(latlngs, { color: '#7c3aed', weight: 4, opacity: 0.85 }).addTo(map);
            line.bindPopup('<b>' + path.name + '</b><br>' + path.date);
            loadedPathLayers.push(line);
            
            // Add endpoint markers
            if (latlngs.length > 0) {
                var startM = L.circleMarker(latlngs[0], { radius: 7, fillColor: '#22c55e', color: '#fff', weight: 2, fillOpacity: 1 }).addTo(map);
                startM.bindPopup('Start: ' + path.name);
                loadedPathLayers.push(startM);
                
                var endM = L.circleMarker(latlngs[latlngs.length - 1], { radius: 7, fillColor: '#ef4444', color: '#fff', weight: 2, fillOpacity: 1 }).addTo(map);
                endM.bindPopup('End: ' + path.name);
                loadedPathLayers.push(endM);
            }
            
            map.fitBounds(line.getBounds(), { padding: [40, 40] });
        };
        
        window.deleteSavedPath = function(idx, e) {
            e.stopPropagation();
            var saved = getSavedPaths();
            saved.splice(idx, 1);
            localStorage.setItem(PATH_STORAGE, JSON.stringify(saved));
            renderSavedPaths();
        };
        
        function renderSavedPaths() {
            var list = document.getElementById('saved-list');
            var saved = getSavedPaths();
            if (saved.length === 0) {
                list.innerHTML = '<div style="color:#9ca3af;font-size:11px;padding:4px;">No saved paths yet</div>';
                return;
            }
            var html = '';
            saved.forEach(function(p, i) {
                html += '<div class="saved-item" onclick="loadSavedPath(' + i + ')">' +
                    '<span class="name">' + p.name + '</span>' +
                    '<span style="color:#9ca3af;font-size:10px;margin:0 4px;">' + (p.date || '') + '</span>' +
                    '<button class="del" onclick="deleteSavedPath(' + i + ', event)" title="Delete">√ó</button>' +
                    '</div>';
            });
            list.innerHTML = html;
        }
        
        renderSavedPaths();
        
        // Keyboard shortcut: Cmd/Ctrl+Z to undo
        document.addEventListener('keydown', function(e) {
            if (e.key === 'z' && (e.ctrlKey || e.metaKey)) { undoLastPoint(); e.preventDefault(); }
        });
    }
    </script>
</body>
</html>
